# Reids的数据的两种存储模式

**Redis中数据存储模式有2种：cache-only,persistence**

* cache-only

> 只做为“缓存”服务，不持久数据，数据在服务终止后将消失，此模式下也将不存在“数据恢复”的手段，是一种安全性低/效率高/容易扩展的方式

* persistence

> 为内存中的数据持久备份到磁盘文件，在服务重启后可以恢复，此模式下数据相对安全。

```
reids 提供了两种持久化方式

1. Redis DataBase简称RDB，也叫定时快照方式（snapshot）
2. Append-only file简称AOF，基于语句追加方式
```

# 两种持久化方式介绍

## RDB（snapshot）

该持久化方式实际是在 Redis 内部一个定时器事件，默认开启。

每隔固定时间去检查当前数据发生的改变次数与时间是否满足配置的持久化触发的条件
如果满足则通过操作系统 fork 调用来创建出一个子进程，这个子进程默认会与父进程共享相同的地址空间，这时就可以通过子进程来遍历整个内存来进行存储操作，而主进程则仍然可以提供服务，当有写入时由操作系统按照内存页（page）为单位来进行 copy-on-write
保证父子进程之间不会互相影响。

持久化结束后，用这个临时文件替换上次持久化的文件，达到数据恢复

> 这里说的这个执行数据写入到临时文件的时间点是可以通过配置来自己确定的，通过配置redis在n秒内如果超过m个key被修改这执行一次RDB操作。

> 这个操作就类似于在这个时间点来保存一次Redis的所有数据，一次快照数据。所有这个持久化方法也通常叫做snapshots。

### 优缺点

* 优点：

使用单独子进程来进行持久化，主进程不会进行任何IO操作，保证了redis的高性能 

* 缺点：

RDB是间隔一段时间进行持久化，如果持久化之间redis发生故障，会发生数据丢失。所以这种方式更适合数据要求不严谨的时候

### 涉及参数

RDB默认开启，redis.conf中的具体配置参数如下

```xml
#dbfilename：持久化数据存储在本地的文件
dbfilename dump.rdb
#dir：持久化数据存储在本地的路径，如果是在/redis/redis-3.0.6/src下启动的redis-cli，则数据会存储在当前src目录下
dir ./
##snapshot触发的时机，save <seconds> <changes>  
##如下为900秒后，至少有一个变更操作，才会snapshot  
##对于此值的设置，需要谨慎，评估系统的变更操作密集程度  
##可以通过“save “””来关闭snapshot功能  
#save时间，以下分别表示更改了1个key时间隔900s进行持久化存储；更改了10个key300s进行存储；更改10000个key60s进行存储。
save 900 1
save 300 10
save 60 10000
##当snapshot时出现错误无法继续时，是否阻塞客户端“变更操作”，“错误”可能因为磁盘已满/磁盘故障/OS级别异常等  
stop-writes-on-bgsave-error yes  
##是否启用rdb文件压缩，默认为“yes”，压缩往往意味着“额外的cpu消耗”，同时也意味这较小的文件尺寸以及较短的网络传输时间  
rdbcompression yes  
```

snapshot触发的时机，是有“间隔时间”和“变更次数”共同决定，同时符合2个条件才会触发snapshot,否则“变更次数”会被继续累加到下一个“间隔时间”上。

snapshot过程中并不阻塞客户端请求。snapshot首先将数据写入临时文件，当成功结束后，将临时文件重名为dump.rdb。

### RDB恢复数据

自动的持久化数据存储到dump.rdb后。实际只要重启redis服务即可完成（启动redis的server时会从dump.rdb中先同步数据）

### 客户端持久化save存储命令

```bash
# 在前台进行存储
./redis-cli -h ip -p port save
# 或者在后台进行存储
./redis-cli -h ip -p port bgsave
```
